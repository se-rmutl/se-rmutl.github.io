<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENGSE214: Web Security Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(at 0% 0%, rgba(6, 182, 212, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.1) 0px, transparent 50%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .font-code { font-family: 'JetBrains Mono', monospace; }

        /* Glassmorphism Card */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Input Styling */
        .cyber-input {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            transition: all 0.3s ease;
        }
        .cyber-input:focus {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.3);
            outline: none;
        }

        /* Option Button Styling */
        .option-btn {
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .option-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .option-btn.selected {
            border-color: var(--accent-cyan);
            background: rgba(6, 182, 212, 0.15);
            color: var(--accent-cyan);
            font-weight: 600;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div id="screen-login" class="w-full max-w-md animate-fade-in">
        <div class="glass-card rounded-2xl p-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 to-green-500"></div>
            
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-cyan-500/10 text-cyan-400 mb-4 border border-cyan-500/30">
                    <i class="fa-solid fa-shield-halved text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">ENGSE214 Exam</h1>
                <p class="text-slate-400 text-sm">Week 7: Web Application Security</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs uppercase tracking-wider text-slate-500 mb-1 font-bold">Student Name</label>
                    <input type="text" id="input-name" class="cyber-input w-full rounded-lg p-3 text-white" placeholder="Enter full name">
                </div>
                <div>
                    <label class="block text-xs uppercase tracking-wider text-slate-500 mb-1 font-bold">Student ID</label>
                    <input type="text" id="input-id" class="cyber-input w-full rounded-lg p-3 text-white font-code" placeholder="XXXXXXXX">
                </div>
                <button onclick="startExam()" class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-cyan-500/20 transition-all transform hover:scale-[1.02]">
                    <i class="fa-solid fa-rocket mr-2"></i> Start Assessment
                </button>
            </div>
            
            <div class="mt-6 text-center text-xs text-slate-600">
                <p>Pass Criteria: 17 / 20 (85%)</p>
                <p>Secure Environment • Anti-Cheat Disabled</p>
            </div>
        </div>
    </div>

    <div id="screen-quiz" class="hidden w-full max-w-5xl animate-fade-in">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-cyan-400 font-bold border border-slate-600">
                    <i class="fa-solid fa-user-graduate"></i>
                </div>
                <div>
                    <h2 id="display-name" class="font-bold text-white leading-tight">Student Name</h2>
                    <p id="display-id" class="text-xs text-slate-400 font-code">ID: XXXXXXXX</p>
                </div>
            </div>
            <div class="text-right">
                <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Progress</div>
                <div class="flex items-center gap-2">
                    <span id="question-counter" class="text-2xl font-bold text-cyan-400 font-code">01</span>
                    <span class="text-slate-500 text-sm">/ 20</span>
                </div>
            </div>
        </div>

        <div class="w-full bg-slate-800 h-1.5 rounded-full mb-8 overflow-hidden">
            <div id="progress-bar" class="h-full bg-cyan-500 transition-all duration-500 ease-out" style="width: 5%"></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-7 space-y-6">
                <div class="glass-card rounded-xl p-6 border-l-4 border-l-cyan-500">
                    <h3 id="question-text" class="text-xl font-semibold text-white leading-relaxed">
                        Loading Question...
                    </h3>
                </div>

                <div id="options-container" class="space-y-3">
                    </div>

                <div class="flex justify-between pt-4">
                    <button id="btn-prev" onclick="prevQuestion()" class="px-6 py-2 rounded-lg border border-slate-600 text-slate-400 hover:bg-slate-800 disabled:opacity-30 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-arrow-left mr-2"></i> Back
                    </button>
                    <button id="btn-next" onclick="nextQuestion()" class="px-8 py-2 rounded-lg bg-cyan-600 text-white font-bold hover:bg-cyan-500 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-cyan-900/50">
                        Next <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                    <button id="btn-submit" onclick="submitExam()" class="hidden px-8 py-2 rounded-lg bg-green-600 text-white font-bold hover:bg-green-500 shadow-lg shadow-green-900/50">
                        Submit Exam <i class="fa-solid fa-check ml-2"></i>
                    </button>
                </div>
            </div>

            <div class="lg:col-span-5">
                <div class="glass-card rounded-xl p-1 h-full min-h-[300px] flex flex-col">
                    <div class="bg-slate-900/50 rounded-lg flex-1 flex items-center justify-center p-6 border border-slate-700/50 relative overflow-hidden group">
                        <div class="absolute top-2 right-2 flex gap-1">
                            <div class="w-2 h-2 rounded-full bg-red-500/50"></div>
                            <div class="w-2 h-2 rounded-full bg-yellow-500/50"></div>
                            <div class="w-2 h-2 rounded-full bg-green-500/50"></div>
                        </div>
                        
                        <div id="visual-container" class="w-full">
                            </div>
                    </div>
                    <div class="p-4">
                        <div class="flex items-start gap-2">
                            <i class="fa-solid fa-circle-info text-cyan-400 mt-1"></i>
                            <p class="text-xs text-slate-400 leading-relaxed">
                                <strong class="text-slate-200">System Hint:</strong> 
                                <span id="visual-caption">Analyzing threat vector...</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="screen-result" class="hidden w-full max-w-2xl animate-fade-in pb-10">
        <div id="result-card" class="glass-card rounded-2xl p-0 overflow-hidden border border-slate-600">
            <div id="result-header" class="p-8 text-center bg-slate-800/50 border-b border-slate-700">
                <div id="status-icon" class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-slate-800 mb-4 border-2">
                    <i class="fa-solid fa-check text-4xl"></i>
                </div>
                <h2 id="status-title" class="text-3xl font-bold mb-2">PASSED</h2>
                <p id="status-msg" class="text-slate-400">Excellent work, Security Engineer.</p>
            </div>

            <div class="grid grid-cols-2 divide-x divide-slate-700 bg-slate-900/30">
                <div class="p-6 text-center">
                    <p class="text-xs uppercase text-slate-500 font-bold mb-1">Score</p>
                    <p id="final-score" class="text-4xl font-bold font-code text-white">18/20</p>
                </div>
                <div class="p-6 text-center">
                    <p class="text-xs uppercase text-slate-500 font-bold mb-1">Student</p>
                    <p id="res-name" class="text-sm font-bold text-white truncate">Student Name</p>
                    <p id="res-id" class="text-xs font-code text-cyan-400">ID: XXXXXXXX</p>
                </div>
            </div>

            <div class="p-6 bg-slate-900/80">
                <h3 class="text-xs uppercase font-bold text-slate-500 mb-4 border-b border-slate-700 pb-2">Threat Analysis Report</h3>
                <div id="review-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                    </div>
            </div>
            
            <div class="p-3 bg-black text-center text-[10px] text-slate-600 font-code">
                ENGSE214 • CERTIFIED ASSESSMENT • DO NOT EDIT
            </div>
        </div>
        <div class="mt-6 flex gap-4">
            <button id="btn-retry" onclick="location.reload()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg font-bold transition-colors">
                <i class="fa-solid fa-rotate-right mr-2"></i> Retry Exam
            </button>
            <button id="btn-capture" onclick="captureResult()" class="hidden flex-1 bg-green-600 hover:bg-green-500 text-white py-3 rounded-lg font-bold shadow-lg shadow-green-900/30 transition-colors">
                <i class="fa-solid fa-camera mr-2"></i> Save Result (PNG)
            </button>
        </div>
    </div>

    <script>
        // --- Data Source (Based on lecture7_web_security_owasp2.md) ---
        const quizData = [
            {
                q: "OWASP ย่อมาจากอะไร?",
                a: "Open Worldwide Application Security Project",
                options: ["Open Web Application Security Project", "Open Worldwide Application Security Project", "Online Web Application Security Program", "Open Web Advanced Security Protocol"],
                type: "info",
                caption: "องค์กรไม่แสวงหากำไรที่เป็นมาตรฐานสากลด้านความปลอดภัยซอฟต์แวร์",
                icon: "fa-globe"
            },
            {
                q: "ใน OWASP Top 10:2025 ช่องโหว่ใดอยู่ในอันดับที่ 1?",
                a: "Broken Access Control",
                options: ["Injection", "Cryptographic Failures", "Broken Access Control", "Security Misconfiguration"],
                type: "chart",
                caption: "ผู้ใช้ทั่วไปสามารถเข้าถึงหน้า Admin หรือข้อมูลของคนอื่นได้",
                chartData: [100, 70, 50, 30] // Fake bars
            },
            {
                q: "SQL Injection คือการโจมตีรูปแบบใด?",
                a: "การแทรกคำสั่ง SQL ผ่าน User Input เพื่อควบคุม Database",
                options: ["การขโมย Session Cookie ของผู้ใช้", "การแทรกคำสั่ง SQL ผ่าน User Input เพื่อควบคุม Database", "การดักจับข้อมูลจราจรบน Network", "การส่ง Request ปลอมเพื่อให้ Server ทำงาน"],
                type: "code",
                code: "SELECT * FROM users WHERE user = '$input'",
                caption: "Input ที่เป็นอันตรายถูกนำไปประมวลผลเป็นคำสั่ง Database"
            },
            {
                q: "Payload นี้มีจุดประสงค์เพื่ออะไร: `' OR '1'='1`",
                a: "Authentication Bypass",
                options: ["ลบฐานข้อมูล (Drop Table)", "ขโมย Cookie (XSS)", "Authentication Bypass", "ทำให้ Server ล่ม (DoS)"],
                type: "code",
                code: "WHERE user = '' OR '1'='1'",
                caption: "เงื่อนไข '1'='1' เป็นจริงเสมอ (True) ทำให้ Query ทำงานสำเร็จ"
            },
            {
                q: "วิธีที่ดีที่สุดในการป้องกัน SQL Injection คือข้อใด?",
                a: "ใช้ Parameterized Queries (Prepared Statements)",
                options: ["ใช้ Blacklist กรองคำว่า SELECT, UNION", "ใช้ Parameterized Queries (Prepared Statements)", "เข้ารหัสข้อมูลในฐานข้อมูล", "ซ่อน Error Message จากผู้ใช้"],
                type: "shield",
                caption: "แยกโครงสร้าง SQL ออกจากข้อมูล Input อย่างชัดเจน",
                icon: "fa-database"
            },
            {
                q: "XSS (Cross-Site Scripting) คืออะไร?",
                a: "การฝัง Script อันตรายให้รันบน Browser ของผู้ใช้",
                options: ["การฝัง Script อันตรายให้รันบน Browser ของผู้ใช้", "การโจมตี Server ให้หยุดทำงาน", "การเดารหัสผ่านของผู้ดูแลระบบ", "การเข้าถึงไฟล์ระบบผ่าน Path Traversal"],
                type: "browser",
                caption: "Attacker ฝัง JS -> Victim เปิดดู -> JS รันขโมยข้อมูล",
                content: "alert('Hacked')"
            },
            {
                q: "XSS ประเภทใดที่ Script ถูกบันทึกลงใน Database และส่งผลกระทบต่อทุกคนที่เข้ามาดู?",
                a: "Stored XSS",
                options: ["Reflected XSS", "DOM-based XSS", "Stored XSS", "Local XSS"],
                type: "db-flow",
                caption: "Attacker Post Comment -> DB Saves -> Victim Loads Page -> Script Runs",
                icon: "fa-server"
            },
            {
                q: "การใช้ฟังก์ชัน `htmlspecialchars()` ใน PHP ช่วยป้องกันอะไร?",
                a: "XSS (โดยการทำ Output Encoding)",
                options: ["SQL Injection", "XSS (โดยการทำ Output Encoding)", "CSRF", "Brute Force"],
                type: "code",
                code: "&lt;script&gt; กลายเป็น &amp;lt;script&amp;gt;",
                caption: "เปลี่ยนอักขระพิเศษเป็น HTML Entities ทำให้ Browser ไม่รัน Script"
            },
            {
                q: "HTTPS (TLS/SSL) มีความสำคัญอย่างไรใน Web Security?",
                a: "ป้องกันการดักฟังและแก้ไขข้อมูลระหว่างทาง (Data in Transit)",
                options: ["ป้องกัน SQL Injection", "ป้องกันการดักฟังและแก้ไขข้อมูลระหว่างทาง (Data in Transit)", "ป้องกันการเข้าถึง Server โดยไม่ได้รับอนุญาต", "ป้องกัน Malware เข้าสู่เครื่องผู้ใช้"],
                type: "network",
                caption: "Encrypt ข้อมูลตั้งแต่ Client จนถึง Server",
                icon: "fa-lock"
            },
            {
                q: "หมวดหมู่ใหม่ที่เพิ่มเข้ามาใน OWASP Top 10:2025 คือข้อใด?",
                a: "Software Supply Chain Failures",
                options: ["Injection", "Software Supply Chain Failures", "Insecure Design", "Broken Authentication"],
                type: "supply-chain",
                caption: "ความเสี่ยงจาก Library หรือ 3rd Party Components ที่เรานำมาใช้",
                icon: "fa-cubes"
            },
            {
                q: "หลักการ 'Input Validation' แบบใดปลอดภัยที่สุด?",
                a: "Whitelist (อนุญาตเฉพาะสิ่งที่รู้ว่าปลอดภัย)",
                options: ["Blacklist (บล็อกสิ่งที่รู้ว่าอันตราย)", "Whitelist (อนุญาตเฉพาะสิ่งที่รู้ว่าปลอดภัย)", "Greylist (ตรวจสอบเฉพาะบางส่วน)", "No Validation (รับทุกอย่างเพื่อความยืดหยุ่น)"],
                type: "filter",
                caption: "กำหนดรูปแบบที่ยอมรับได้ (เช่น อีเมลต้องมี @) นอกเหนือจากนั้นปฏิเสธ",
                icon: "fa-filter"
            },
            {
                q: "Cookie Flag ใดช่วยป้องกัน JavaScript เข้าถึง Cookie (ลดความเสี่ยง XSS)?",
                a: "HttpOnly",
                options: ["Secure", "SameSite", "HttpOnly", "Domain"],
                type: "code",
                code: "Set-Cookie: sess=xyz; HttpOnly",
                caption: "document.cookie จะไม่สามารถอ่านค่านี้ได้"
            },
            {
                q: "Security Misconfiguration มักเกิดจากอะไร?",
                a: "การใช้ Default Password หรือเปิดฟีเจอร์ที่ไม่จำเป็น",
                options: ["การเขียน Code Logic ผิดพลาด", "การใช้ Default Password หรือเปิดฟีเจอร์ที่ไม่จำเป็น", "การไม่ติดตั้ง Antivirus บนเครื่อง Client", "การใช้ Library เวอร์ชันเก่า"],
                type: "config",
                caption: "เช่น admin/admin, เปิด Debug Mode ใน Production",
                icon: "fa-gears"
            },
            {
                q: "หลักการ 'Least Privilege' หมายถึงอะไร?",
                a: "ให้สิทธิ์ผู้ใช้เท่าที่จำเป็นต่อการทำงานเท่านั้น",
                options: ["ให้สิทธิ์ทุกคนเป็น Admin เพื่อความสะดวก", "ให้สิทธิ์ผู้ใช้เท่าที่จำเป็นต่อการทำงานเท่านั้น", "ให้สิทธิ์ตามความอาวุโสของพนักงาน", "การไม่ให้สิทธิ์ใครเข้าถึงระบบเลย"],
                type: "access",
                caption: "User ธรรมดาไม่ควรลบ Database ได้",
                icon: "fa-user-shield"
            },
            {
                q: "A02:2025 ใน OWASP ปรับจาก Cryptographic Failures เป็นอะไร?",
                a: "Security Misconfiguration",
                options: ["Injection", "Broken Access Control", "Security Misconfiguration", "Vulnerable Components"],
                type: "rank-change",
                caption: "Security Misconfiguration ขยับขึ้นมาเป็นอันดับ 2 ในปี 2025",
                icon: "fa-arrow-up"
            },
            {
                q: "การโจมตีแบบใดที่ Attacker ไม่เห็นผลลัพธ์โดยตรง แต่เดาจาก Error หรือเวลาตอบสนอง?",
                a: "Blind SQL Injection",
                options: ["Classic SQL Injection", "Blind SQL Injection", "DOM XSS", "Phishing"],
                type: "timer",
                caption: "Payload: ' AND SLEEP(5)-- (ถ้ารอ 5 วิ แสดงว่าเงื่อนไขถูก)",
                icon: "fa-stopwatch"
            },
            {
                q: "Content Security Policy (CSP) ใช้เพื่อวัตถุประสงค์ใด?",
                a: "จำกัดแหล่งที่มาของ Content (Script, Img, Style) ที่ Browser โหลดได้",
                options: ["เข้ารหัสข้อมูลใน Database", "จำกัดแหล่งที่มาของ Content เพื่อป้องกัน XSS", "ตรวจสอบความแข็งแรงของรหัสผ่าน", "จัดการ Session Timeout"],
                type: "shield-web",
                caption: "Header: script-src 'self' (ห้ามโหลด Script ภายนอก)",
                icon: "fa-shield-virus"
            },
            {
                q: "Supply Chain Attack ที่โด่งดังในปี 2020-2021 คือเคสใด?",
                a: "SolarWinds / Log4Shell",
                options: ["WannaCry", "SolarWinds / Log4Shell", "Heartbleed", "Stuxnet"],
                type: "alert",
                caption: "โจมตีที่ต้นน้ำ (Vendor/Library) ส่งผลกระทบต่อผู้ใช้ปลายนับล้าน",
                icon: "fa-triangle-exclamation"
            },
            {
                q: "หากต้องการตรวจสอบว่า Library ที่ใช้มีช่องโหว่หรือไม่ ควรทำอย่างไร?",
                a: "ใช้เครื่องมือ SCA (เช่น npm audit, OWASP Dependency Check)",
                options: ["อ่าน Source Code ทีละบรรทัด", "ใช้เครื่องมือ SCA (เช่น npm audit)", "ถามใน StackOverflow", "รอให้โดนแฮกก่อนแล้วค่อยแก้"],
                type: "scan",
                caption: "Scan ส่วนประกอบของซอฟต์แวร์เพื่อหา Known Vulnerabilities",
                icon: "fa-magnifying-glass-chart"
            },
            {
                q: "ข้อใดไม่ใช่แนวทาง Secure Coding?",
                a: "Trust User Input (เชื่อใจข้อมูลจากผู้ใช้)",
                options: ["Input Validation", "Output Encoding", "Trust User Input", "Parameterized Queries"],
                type: "danger",
                caption: "Golden Rule: Never Trust User Input!",
                icon: "fa-ban"
            }
        ];

        // --- State Management ---
        let currentState = {
            studentName: '',
            studentId: '',
            currentQuestionIndex: 0,
            answers: new Array(quizData.length).fill(null),
            score: 0
        };

        // --- Logic ---

        function startExam() {
            const name = document.getElementById('input-name').value.trim();
            const id = document.getElementById('input-id').value.trim();

            if (!name || !id) {
                alert("Please identify yourself before proceeding.");
                return;
            }

            currentState.studentName = name;
            currentState.studentId = id;

            // UI Transition
            document.getElementById('screen-login').classList.add('hidden');
            document.getElementById('screen-quiz').classList.remove('hidden');
            
            // Set Header
            document.getElementById('display-name').innerText = name;
            document.getElementById('display-id').innerText = `ID: ${id}`;

            loadQuestion(0);
        }

        function loadQuestion(index) {
            const data = quizData[index];
            const qCounter = document.getElementById('question-counter');
            const qText = document.getElementById('question-text');
            const optionsContainer = document.getElementById('options-container');
            const progressBar = document.getElementById('progress-bar');
            
            // Update Progress
            qCounter.innerText = (index + 1).toString().padStart(2, '0');
            progressBar.style.width = `${((index + 1) / quizData.length) * 100}%`;
            
            // Update Text
            qText.innerText = `${index + 1}. ${data.q}`;

            // Render Options
            optionsContainer.innerHTML = '';
            data.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = `option-btn w-full text-left p-4 rounded-lg bg-slate-800 border border-slate-700 hover:bg-slate-700 text-slate-200 transition-all ${currentState.answers[index] === opt ? 'selected' : ''}`;
                btn.onclick = () => selectOption(index, opt);
                
                // Content with icon bullet
                const content = `
                    <div class="flex items-start gap-3">
                        <div class="mt-1 w-4 h-4 rounded-full border border-slate-500 flex-shrink-0 flex items-center justify-center ${currentState.answers[index] === opt ? 'bg-cyan-500 border-cyan-500' : ''}">
                            ${currentState.answers[index] === opt ? '<div class="w-2 h-2 bg-white rounded-full"></div>' : ''}
                        </div>
                        <span class="${currentState.answers[index] === opt ? 'text-cyan-400' : ''}">${opt}</span>
                    </div>
                `;
                btn.innerHTML = content;
                optionsContainer.appendChild(btn);
            });

            // Update Navigation Buttons
            document.getElementById('btn-prev').disabled = index === 0;
            if (index === quizData.length - 1) {
                document.getElementById('btn-next').classList.add('hidden');
                document.getElementById('btn-submit').classList.remove('hidden');
                // Check if last question answered to enable submit
                document.getElementById('btn-submit').disabled = !currentState.answers[index];
            } else {
                document.getElementById('btn-next').classList.remove('hidden');
                document.getElementById('btn-submit').classList.add('hidden');
                document.getElementById('btn-next').disabled = !currentState.answers[index];
            }

            // Render Infographic
            renderVisual(data);
        }

        function renderVisual(data) {
            const container = document.getElementById('visual-container');
            const caption = document.getElementById('visual-caption');
            caption.innerText = data.caption;
            container.innerHTML = ''; // Clear

            let html = '';

            // Generate HTML based on 'type' to simulate infographic
            switch (data.type) {
                case 'code':
                    html = `
                        <div class="w-full bg-slate-950 rounded-lg p-3 border border-slate-700 font-code text-xs text-green-400 shadow-inner">
                            <div class="flex gap-1.5 mb-2 border-b border-slate-800 pb-2">
                                <div class="w-2 h-2 rounded-full bg-red-500"></div>
                                <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            </div>
                            <span class="text-purple-400">const</span> <span class="text-blue-400">query</span> = <span class="text-orange-300">"${data.code || 'SELECT *'}"</span>;
                        </div>
                    `;
                    break;
                case 'browser':
                    html = `
                        <div class="w-full bg-slate-100 rounded-t-lg h-24 relative overflow-hidden">
                            <div class="bg-slate-300 h-6 w-full flex items-center px-2 gap-1">
                                <div class="w-2 h-2 bg-slate-500 rounded-full"></div>
                                <div class="bg-white h-4 w-3/4 rounded text-[8px] flex items-center px-2 text-slate-500">example.com/search?q=<script>...</div>
                            </div>
                            <div class="absolute top-10 left-10 bg-white border border-slate-300 shadow-xl rounded p-2 animate-bounce">
                                <div class="text-black text-xs font-bold">Alert</div>
                                <div class="text-black text-[10px]">Hacked!</div>
                                <div class="mt-1 bg-blue-500 text-white text-[8px] w-8 text-center rounded">OK</div>
                            </div>
                        </div>
                    `;
                    break;
                case 'chart':
                    html = `
                        <div class="flex items-end justify-center gap-2 h-24 w-full">
                            <div class="w-8 bg-red-500 rounded-t h-[80%] relative group"><div class="absolute -top-4 left-0 w-full text-center text-[10px] text-red-400">#1</div></div>
                            <div class="w-8 bg-orange-500 rounded-t h-[60%]"></div>
                            <div class="w-8 bg-yellow-500 rounded-t h-[40%]"></div>
                            <div class="w-8 bg-blue-500 rounded-t h-[20%]"></div>
                        </div>
                    `;
                    break;
                 case 'db-flow':
                    html = `
                         <div class="flex items-center justify-between w-full text-2xl text-slate-600">
                            <i class="fa-solid fa-user-secret text-red-500"></i>
                            <i class="fa-solid fa-arrow-right text-sm"></i>
                            <i class="fa-solid fa-database text-blue-500 animate-pulse"></i>
                            <i class="fa-solid fa-arrow-right text-sm"></i>
                            <i class="fa-solid fa-users text-green-500"></i>
                         </div>
                    `;
                    break;
                default:
                    // Default Icon Layout
                    html = `
                        <div class="w-24 h-24 rounded-full bg-slate-800 border-2 border-dashed border-slate-600 flex items-center justify-center shadow-[0_0_20px_rgba(6,182,212,0.1)]">
                            <i class="fa-solid ${data.icon || 'fa-shield-halved'} text-5xl text-cyan-500"></i>
                        </div>
                    `;
            }

            container.innerHTML = html;
        }

        function selectOption(index, option) {
            currentState.answers[index] = option;
            loadQuestion(index); // Re-render to update UI state
        }

        function nextQuestion() {
            if (currentState.currentQuestionIndex < quizData.length - 1) {
                currentState.currentQuestionIndex++;
                loadQuestion(currentState.currentQuestionIndex);
            }
        }

        function prevQuestion() {
            if (currentState.currentQuestionIndex > 0) {
                currentState.currentQuestionIndex--;
                loadQuestion(currentState.currentQuestionIndex);
            }
        }

        function submitExam() {
            // Confirm?
            if (!confirm("Confirm submission? You cannot change answers after this.")) return;

            // Calculate Score
            let score = 0;
            const reviewContainer = document.getElementById('review-list');
            reviewContainer.innerHTML = ''; // Clear old reviews

            quizData.forEach((data, index) => {
                const userAns = currentState.answers[index];
                const isCorrect = userAns === data.a;
                if (isCorrect) score++;

                // Build Review Item
                const reviewItem = document.createElement('div');
                reviewItem.className = `p-3 rounded mb-2 text-xs border-l-4 ${isCorrect ? 'bg-green-900/20 border-green-500' : 'bg-red-900/20 border-red-500'}`;
                reviewItem.innerHTML = `
                    <div class="flex justify-between font-bold mb-1">
                        <span class="text-slate-300">Q${index + 1}</span>
                        <span class="${isCorrect ? 'text-green-400' : 'text-red-400'}">${isCorrect ? 'CORRECT' : 'INCORRECT'}</span>
                    </div>
                    <div class="text-white mb-1">${data.q}</div>
                    <div class="text-slate-400">Your Answer: <span class="${isCorrect ? 'text-green-300' : 'text-red-300'}">${userAns}</span></div>
                    ${!isCorrect ? `<div class="text-cyan-600 mt-1">Correct: ${data.a}</div>` : ''}
                `;
                reviewContainer.appendChild(reviewItem);
            });

            currentState.score = score;

            // UI Transition to Result
            document.getElementById('screen-quiz').classList.add('hidden');
            document.getElementById('screen-result').classList.remove('hidden');

            // Render Result Card
            document.getElementById('final-score').innerText = `${score}/20`;
            document.getElementById('res-name').innerText = currentState.studentName;
            document.getElementById('res-id').innerText = `ID: ${currentState.studentId}`;

            const statusIcon = document.getElementById('status-icon');
            const statusTitle = document.getElementById('status-title');
            const statusMsg = document.getElementById('status-msg');
            const btnCapture = document.getElementById('btn-capture');

            // Pass Criteria: 17
            if (score >= 17) {
                // Pass
                statusIcon.className = "inline-flex items-center justify-center w-20 h-20 rounded-full bg-green-500/10 mb-4 border-2 border-green-500 text-green-500 shadow-[0_0_20px_rgba(16,185,129,0.3)]";
                statusIcon.innerHTML = '<i class="fa-solid fa-shield-check text-4xl"></i>';
                statusTitle.innerText = "PASSED";
                statusTitle.className = "text-3xl font-bold mb-2 text-green-400 tracking-wider";
                statusMsg.innerText = "Security clearance granted. You have mastered the curriculum.";
                btnCapture.classList.remove('hidden');
            } else {
                // Fail
                statusIcon.className = "inline-flex items-center justify-center w-20 h-20 rounded-full bg-red-500/10 mb-4 border-2 border-red-500 text-red-500 shadow-[0_0_20px_rgba(239,68,68,0.3)]";
                statusIcon.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-4xl"></i>';
                statusTitle.innerText = "FAILED";
                statusTitle.className = "text-3xl font-bold mb-2 text-red-400 tracking-wider";
                statusMsg.innerText = "Insufficient score (Req: 17). Review OWASP materials and retry.";
                btnCapture.classList.add('hidden');
            }
        }

        function captureResult() {
            const captureZone = document.getElementById('result-card');
            
            // Temporary Style Adjustments for clean capture
            captureZone.style.borderRadius = "0"; 
            
            html2canvas(captureZone, {
                backgroundColor: "#0f172a",
                scale: 2 // High Res
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `ENGSE214_Result_${currentState.studentId}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                
                // Revert style
                captureZone.style.borderRadius = "1rem";
            });
        }
    </script>
</body>
</html>